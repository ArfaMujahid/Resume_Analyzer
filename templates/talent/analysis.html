{% extends 'base.html' %}
{% load static %}

{% block title %}Run Analysis - {{ site_name }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Progress Steps -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="step-item text-center" style="flex: 1;">
                            <div class="step-circle bg-primary text-white">
                                <i class="fas fa-file"></i>
                            </div>
                            <p class="mb-0 mt-2 fw-bold">Resume</p>
                        </div>
                        <div class="step-item text-center" style="flex: 1;">
                            <div class="step-circle bg-primary text-white">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <p class="mb-0 mt-2 fw-bold">Job Description</p>
                        </div>
                        <div class="step-item text-center" style="flex: 1;">
                            <div class="step-circle bg-light text-muted">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <p class="mb-0 mt-2 text-muted">Results</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <h2 class="card-title text-center mb-4">Analyze Your Resume Match</h2>
                    <p class="text-center text-muted mb-5">
                        Select a resume and job description to see how well they match
                    </p>

                    <form method="post" id="analysisForm" action="{% url 'talent:analyze_resume' %}">
                        {% csrf_token %}

                        <!-- Resume Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="mb-3">
                                    <i class="fas fa-file-alt me-2"></i>Select Resume
                                </h5>
                                {% if resumes %}
                                    <div class="list-group">
                                        {% for resume in resumes %}
                                            <label class="list-group-item list-group-item-action">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <input type="radio" name="resume_id" value="{{ resume.id }}"
                                                               class="form-check-input me-3" required>
                                                        <div>
                                                            <h6 class="mb-1">{{ resume.original_filename }}</h6>
                                                            <small class="text-muted">
                                                                {{ resume.created_at|date:"M d, Y" }} •
                                                                {{ resume.file_size_bytes|filesizeformat }}
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <span class="status-badge status-{{ resume.status }}">
                                                        {{ resume.get_status_display }}
                                                    </span>
                                                </div>
                                            </label>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No resumes found. <a href="{% url 'resumes:upload' %}">Upload a resume</a> to get started.
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Job Description Selection -->
                            <div class="col-md-6">
                                <h5 class="mb-3">
                                    <i class="fas fa-briefcase me-2"></i>Select Job Description
                                </h5>
                                {% if job_descriptions %}
                                    <div class="list-group">
                                        {% for job in job_descriptions %}
                                            <label class="list-group-item list-group-item-action">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <input type="radio" name="job_description_id" value="{{ job.id }}"
                                                               class="form-check-input me-3" required>
                                                        <div>
                                                            <h6 class="mb-1">{{ job.title }}</h6>
                                                            <small class="text-muted">
                                                                {{ job.company|default:"No company" }} •
                                                                {{ job.created_at|date:"M d, Y" }}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        {% endfor %}
                                    </div>
                                    <div class="mt-3">
                                        <a href="{% url 'jobs:create' %}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-plus me-2"></i>Add New Job Description
                                        </a>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No job descriptions found. <a href="{% url 'jobs:create' %}">Add one</a> to get started.
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Quick Add Options -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-upload me-2"></i>Quick Upload Resume
                                        </h6>
                                        <p class="card-text small text-muted">
                                            Don't see your resume? Upload a new one.
                                        </p>
                                        <a href="{% url 'resumes:upload' %}" class="btn btn-sm btn-outline-primary">
                                            Upload Resume
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-paste me-2"></i>Paste Job Description
                                        </h6>
                                        <p class="card-text small text-muted">
                                            Have a job description in text? Add it quickly.
                                        </p>
                                        <a href="{% url 'jobs:create' %}" class="btn btn-sm btn-outline-primary">
                                            Add Job Description
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                <i class="fas fa-play me-2"></i>Run Analysis
                            </button>
                            <p class="text-muted small mt-2">
                                Analysis typically takes 30-60 seconds
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('analysisForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting Analysis...';

            // Disable page interaction
            document.body.style.pointerEvents = 'none';
            document.body.style.overflow = 'hidden';

            // Show progress overlay immediately
            showProgressOverlay();

            // Collect form data
            const formData = new FormData(form);

            // Submit via AJAX
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to results page
                    window.location.href = data.redirect_url;
                } else {
                    // Show error
                    hideProgressOverlay();
                    showErrorModal('Error: ' + (data.error || 'Analysis failed'));
                    // Reset button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-play me-2"></i>Run Analysis';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                hideProgressOverlay();
                showErrorModal('An error occurred. Please try again.');
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-play me-2"></i>Run Analysis';
            });
        });
    }
});

function showProgressOverlay() {
    // Create progress overlay if it doesn't exist
    let overlay = document.getElementById('progressOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'progressOverlay';
        overlay.className = 'progress-overlay';
        overlay.innerHTML = `
            <div class="progress-content">
                <div class="progress-spinner"></div>
                <h4>Analyzing Your Resume...</h4>
                <p class="text-muted">Please wait while we analyze your resume against the job description.</p>
                <div class="progress-container">
                    <div class="progress-bar-container">
                        <div id="analysisProgressBar" class="progress-bar-fill" style="width: 0%">
                            0%
                        </div>
                    </div>
                </div>
                <div id="progressStatus" class="mt-3 text-muted">
                    <small>Initializing analysis...</small>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    }
    overlay.style.display = 'flex';

    // Simulate progress updates
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress = Math.min(90, progress + Math.random() * 20);
        updateAnalysisProgress(progress);

        if (progress >= 90) {
            clearInterval(progressInterval);
            document.getElementById('progressStatus').innerHTML = '<small>Finalizing results...</small>';
        }
    }, 1000);

    // Store interval ID so we can clear it later
    window.progressInterval = progressInterval;
}

function updateAnalysisProgress(percent) {
    const progressBar = document.getElementById('analysisProgressBar');
    if (progressBar) {
        progressBar.style.width = percent + '%';
        progressBar.textContent = Math.round(percent) + '%';
    }

    // Update status messages based on progress
    const statusElement = document.getElementById('progressStatus');
    if (statusElement) {
        let status = 'Analyzing...';
        if (percent > 80) {
            status = 'Generating recommendations...';
        } else if (percent > 60) {
            status = 'Calculating match scores...';
        } else if (percent > 40) {
            status = 'Extracting skills and experience...';
        } else if (percent > 20) {
            status = 'Processing resume content...';
        }
        statusElement.innerHTML = `<small>${status}</small>`;
    }
}

function hideProgressOverlay() {
    const overlay = document.getElementById('progressOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    // Re-enable page interaction
    document.body.style.pointerEvents = 'auto';
    document.body.style.overflow = 'auto';
    // Clear any running progress interval
    if (window.progressInterval) {
        clearInterval(window.progressInterval);
    }
}

// Hide progress overlay when page is unloaded (in case of navigation)
window.addEventListener('beforeunload', hideProgressOverlay);
</script>

<style>
.step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    font-size: 1.2rem;
}

.step-item {
    position: relative;
}

.step-item:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 25px;
    right: -50%;
    width: 100%;
    height: 2px;
    background: #e9ecef;
    z-index: -1;
}

.progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.progress-content {
    text-align: center;
    max-width: 500px;
    padding: 2rem;
}

.progress-spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #1f6b4f;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}

.progress-container {
    margin: 2rem 0;
}

.progress-bar-container {
    background: #e9ecef;
    border-radius: 10px;
    height: 25px;
    overflow: hidden;
}

.progress-bar-fill {
    background: linear-gradient(90deg, #1f6b4f, #15513b);
    height: 100%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
